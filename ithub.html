<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Support Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Syntax Highlighting (for rendered code) -->
    <link id="hljs-theme-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <!-- Editor: EasyMDE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- Icons for EasyMDE -->

    <style>
        /* Use highlight.js's theme for all <pre><code> blocks */
        .prose-custom pre {
            /* background-color is handled by the theme files */
            color: inherit;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
        }
        .prose-custom pre code.hljs {
            padding: 0; 
            background-color: transparent;
        }
    </style>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-gray-200;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-gray-400 rounded-md;
        }
        ::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-500;
        }
        
        /* Markdown Preview Styles */
        .prose-custom {
            @apply text-gray-700;
        }
        .prose-custom p, .prose-custom li {
            @apply text-gray-700;
        }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 {
            @apply text-gray-900;
        }
        .prose-custom strong {
            @apply text-gray-900;
        }
        .prose-custom code:not(pre code) { /* Inline code */
            @apply text-orange-700 bg-gray-200 px-1 py-0.5 rounded-sm;
        }
        .prose-custom a {
            @apply text-green-800 underline;
        }
        .prose-custom blockquote {
            @apply border-green-600 text-gray-500;
        }
        
        /* Favorite Button Style */
        .favorite-btn {
            color: #aaa; /* Default: empty star */
            font-size: 2rem;
            line-height: 1;
            padding: 0.25rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
        }
        .favorite-btn:hover {
            color: #facc15; /* yellow-400 */
            transform: scale(1.1);
        }
        .favorite-btn.is-favorite {
            color: #facc15; /* yellow-400 */
        }

        /* EasyMDE Theme Tweaks */
        .EasyMDEContainer {
            @apply border-gray-300 rounded-md;
        }
        .EasyMDEContainer .CodeMirror {
            @apply border-gray-300 bg-white;
        }
        .EasyMDEContainer .editor-toolbar {
            @apply bg-gray-50 border-b-gray-300;
        }
        .EasyMDEContainer .editor-toolbar button {
            @apply text-gray-700;
        }
        .EasyMDEContainer .editor-toolbar button:hover,
        .EasyMDEContainer .editor-toolbar button.active {
            @apply bg-gray-200 border-gray-300;
        }
        .EasyMDEContainer .editor-statusbar {
            @apply bg-gray-50 border-t-gray-300 text-gray-500;
        }
        .EasyMDEContainer .CodeMirror-scroll {
            min-height: 350px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes modalFadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes modalFadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .view {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .animate-slide-in-up {
            opacity: 0; /* Start hidden */
            animation: slideInUp 0.4s ease-out forwards;
        }
        
        .modal-backdrop {
            animation: fadeIn 0.2s ease-out forwards;
        }
        .modal-backdrop-out {
            animation: fadeIn 0.2s ease-out forwards reverse;
        }
        
        .modal-content {
            animation: modalFadeInScale 0.2s ease-out forwards;
        }
        .modal-content-out {
            animation: modalFadeOutScale 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="h-full flex flex-col">
    <!-- Header -->
    <header id="app-header" class="w-full flex-shrink-0 bg-white border-b border-gray-200 shadow-md flex items-center gap-4 p-4 hidden">
        <a href="#" class="text-2xl font-bold text-[#000f21] flex-shrink-0">IT Support Hub</a>
        
        <!-- Global Search Bar -->
        <div class="flex-1 max-w-2xl mx-auto">
            <input type="search" id="search-bar" placeholder="Search all entries..." class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-700">
        </div>
        
        <div class="flex items-center space-x-4 flex-shrink-0">
            <!-- Dark Mode Toggle Button Removed -->
            
            <div class="text-xs text-gray-500 text-right">
                <span id="user-name-display" class="text-gray-700 font-medium"></span><br>
                User ID:
                <span id="user-id-display" class="text-gray-700 bg-gray-200 p-1 rounded-md cursor-pointer" title="Click to copy User ID">Loading...</span>
            </div>
            <button id="sign-out-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200">Sign Out</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-main" class="flex-1 overflow-y-auto p-6 lg:p-10 hidden">
        
        <!-- View: Home -->
        <div id="home-view" class="view">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-[#000f21]">Welcome to the IT Support Hub</h1>
                <p class="mt-2 text-lg text-gray-600">Your central hub for fixes, guides, configs, and links.</p>
                <button id="add-new-item-btn-home" class="mt-8 bg-green-700 hover:bg-green-800 text-white font-semibold py-3 px-6 rounded-md shadow-md text-lg transition duration-200">
                    + Add New Entry
                </button>
            </div>
            
            <!-- Category Cards -->
            <div id="home-card-grid" class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Fixes Card -->
                <a href="#list/fix" class="home-card group bg-white p-6 rounded-md shadow-md hover:shadow-lg transition duration-200 block opacity-0">
                    <h2 class="text-2xl font-bold text-[#000f21]">Fixes</h2>
                    <p class="mt-2 text-gray-600">Quick solutions and troubleshooting steps.</p>
                    <span class="mt-4 inline-block text-green-700 group-hover:text-green-800">View Fixes &rarr;</span>
                </a>
                <!-- Guides Card -->
                <a href="#list/guide" class="home-card group bg-white p-6 rounded-md shadow-md hover:shadow-lg transition duration-200 block opacity-0">
                    <h2 class="text-2xl font-bold text-[#000f21]">Guides</h2>
                    <p class="mt-2 text-gray-600">In-depth walkthroughs and "how-to" articles.</p>
                    <span class="mt-4 inline-block text-green-700 group-hover:text-green-800">View Guides &rarr;</span>
                </a>
                <!-- Configs Card -->
                <a href="#list/config" class="home-card group bg-white p-6 rounded-md shadow-md hover:shadow-lg transition duration-200 block opacity-0">
                    <h2 class="text-2xl font-bold text-[#000f21]">Configs & Scripts</h2>
                    <p class="mt-2 text-gray-600">Useful scripts and configuration files.</p>
                    <span class="mt-4 inline-block text-green-700 group-hover:text-green-800">View Configs &rarr;</span>
                </a>
                <!-- Links Card -->
                <a href="#list/link" class="home-card group bg-white p-6 rounded-md shadow-md hover:shadow-lg transition duration-200 block opacity-0">
                    <h2 class="text-2xl font-bold text-[#000f21]">Useful Links</h2>
                    <p class="mt-2 text-gray-600">External resources and documentation.</p>
                    <span class="mt-4 inline-block text-green-700 group-hover:text-green-800">View Links &rarr;</span>
                </a>
            </div>

            <!-- New: Popular Links -->
            <div id="popular-links-section" class="mt-12">
                <h2 class="text-2xl font-bold text-[#000f21] mb-4">Popular Links</h2>
                <div id="popular-links-list" class="space-y-3">
                    <p class="text-gray-500">Loading popular links...</p>
                    <!-- Popular links will be rendered here -->
                </div>
            </div>

            <!-- My Favorites -->
            <div id="my-favorites-section" class="mt-12">
                <h2 class="text-2xl font-bold text-[#000f21] mb-4">My Favorites</h2>
                <div id="my-favorites-list" class="space-y-3">
                    <p class="text-gray-500">Loading favorites...</p>
                    <!-- Favorite entries will be rendered here -->
                </div>
            </div>
            
            <!-- Recently Updated -->
            <div id="recently-updated-section" class="mt-12">
                <h2 class="text-2xl font-bold text-[#000f21] mb-4">Recently Updated</h2>
                <div id="recently-updated-list" class="space-y-3">
                    <p class="text-gray-500">Loading recent entries...</p>
                    <!-- Recent entries will be rendered here -->
                </div>
                <div class="text-center mt-6">
                    <a href="#list/all" class="text-gray-600 hover:text-black transition duration-200">View All Entries &rarr;</a>
                </div>
            </div>
        </div>

        <!-- View: List -->
        <div id="list-view" class="view hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <a href="#" class="text-green-700 hover:text-green-800 text-sm">&larr; Back to Home</a>
                    <h1 id="list-view-title" class="text-3xl font-bold text-[#000f21] mt-1">All Entries</h1>
                </div>
                <button id="add-new-item-btn-list" class="bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-200">
                    + Add New Entry
                </button>
            </div>
            <!-- Search bar is now in the header -->
            <div id="list-view-entries" class="mt-6 space-y-3">
                <!-- Entries will be rendered here by JS -->
            </div>
        </div>
        
        <!-- View: Entry Detail -->
        <div id="detail-view" class="view hidden">
            <div class="mb-6">
                <a id="back-to-list-btn" href="#list/all" class="text-green-700 hover:text-green-800 text-sm">&larr; Back to List</a>
            </div>
            <div id="entry-detail-content" class="bg-white p-6 rounded-md shadow-md">
                <!-- Content will be injected by JS -->
            </div>
        </div>

    </main>

    <!-- View: Sign In -->
    <div id="sign-in-view" class="flex-1 flex flex-col items-center justify-center p-6 hidden">
        <div class="bg-white p-10 rounded-md shadow-xl text-center w-full max-w-md">
            <h1 class="text-3xl font-bold text-[#000f21] mb-4">IT Support Hub</h1>
            <p class="text-gray-600 mb-8">Please sign in with your Microsoft 365 account to continue.</p>
            <button id="sign-in-btn" class="w-full flex items-center justify-center bg-green-700 hover:bg-green-800 text-white font-semibold py-3 px-6 rounded-md shadow-md text-lg transition duration-200">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.0001 2.40015L12 6.09615C10.024 6.12615 8.096 6.94215 6.634 8.40415C5.172 9.86615 4.356 11.7941 4.326 13.7701L0.630005 13.7701C0.660005 9.76815 3.142 6.27015 6.634 4.32615C8.404 3.14215 10.45 2.58015 12.576 2.58015L12.0001 2.40015Z M13.77 4.32615L13.77 0.63015C17.772 0.66015 21.27 3.14215 23.214 6.63415C24.398 8.40415 25.022 10.4501 25.022 12.5761C25.022 14.7021 24.398 16.7481 23.214 18.5181C21.27 22.0101 17.772 24.4921 13.77 24.5221L13.77 20.8261C15.746 20.7961 17.674 19.9801 19.136 18.5181C20.598 17.0561 21.414 15.1281 21.444 13.1521L17.748 13.1521C17.718 15.1281 16.902 17.0561 15.44 18.5181C13.978 19.9801 12.05 20.7961 10.074 20.8261L10.074 24.5221C6.072 24.4921 2.574 22.0101 0.630005 18.5181C-0.553995 16.7481 -1.178 14.7021 -1.178 12.5761C-1.178 10.4501 -0.553995 8.40415 0.630005 6.63415L4.326 6.63415C4.356 8.61015 5.172 10.5381 6.634 11.9901C8.096 13.4621 10.024 14.2781 12 14.3081L12 10.6121C10.024 10.5821 8.096 9.76615 6.634 8.20415L10.074 8.20415L10.074 4.32615L13.77 4.32615Z" transform="translate(-0.63 -0.576)"/>
                </svg>
                Sign in with Microsoft
            </button>
            <p id="sign-in-error" class="text-red-500 mt-4 hidden"></p>
        </div>
    </div>

    <!-- Modal for Add/Edit Item -->
    <div id="entry-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white rounded-md shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 id="modal-title" class="text-xl font-bold text-[#000f21]">Add New Entry</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-black">&times;</button>
            </div>
            
            <form id="entry-form" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="entry-id-field">
                
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <label for="entry-title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="entry-title" name="title" required class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-green-700 focus:border-green-700">
                    </div>
                    <div class="ml-6 pt-6 flex items-center space-x-2">
                        <input type="checkbox" id="entry-pinned" name="isPinned" class="h-4 w-4 text-green-700 border-gray-300 rounded focus:ring-green-700">
                        <label for="entry-pinned" class="text-sm font-medium text-gray-700">Pin this entry?</label>
                    </div>
                </div>

                <div>
                    <label for="entry-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="entry-category" name="category" required class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-green-700 focus:border-green-700">
                        <option value="fix">Fix</option>
                        <option value="guide">Guide</option>
                        <option value="config">Config / Script</option>
                        <option value="link">Useful Link</option>
                    </select>
                </div>

                <!-- Dynamic fields based on category -->
                <div id="field-group-content" class="space-y-4">
                    <label for="entry-content" class="block text-sm font-medium text-gray-700">Content</label>
                    
                    <!-- New EasyMDE Editor replaces the old layout -->
                    <textarea id="entry-content" name="content"></textarea>
                    
                    <!-- Image Upload (remains) -->
                    <div>
                        <label for="entry-image-upload" class="block text-sm font-medium text-gray-700">Upload Image</label>
                        <input type="file" id="entry-image-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-700 file:text-white hover:file:bg-green-800 cursor-pointer">
                        <p id="image-upload-status" class="mt-1 text-xs text-gray-500">Select an image to upload. It will be automatically added to the content area.</p>
                    </div>
                </div>
                
                <div id="field-group-script" class="hidden space-y-4">
                    <label for="entry-script" class="block text-sm font-medium text-gray-700">Script / Config Content</label>
                    <p class="text-xs text-gray-500">Paste the full content of your script or config file here. This is the 'file upload' for our wiki.</p>
                    <textarea id="entry-script" name="scriptOrConfigContent" rows="15" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 font-mono text-sm focus:outline-none focus:ring-green-700 focus:border-green-700" placeholder="Paste your script (PowerShell, Bash, etc.) or config (JSON, YAML, INI) here..."></textarea>
                </div>
                
                <div id="field-group-link" class="hidden space-y-4">
                    <label for="entry-url" class="block text-sm font-medium text-gray-700">URL</label>
                    <input type="url" id="entry-url" name="url" placeholder="https://example.com" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-green-700 focus:border-green-700">
                </div>

                <!-- Tags Input -->
                <div>
                    <label for="entry-tags" class="block text-sm font-medium text-gray-700">Tags</label>
                    <input type="text" id="entry-tags" name="tags" placeholder="e.g. vpn, printer, azure, m365" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-green-700 focus:border-green-700">
                    <p class="mt-1 text-xs text-gray-500">Separate tags with a comma.</p>
                </div>

                <!-- Suggested Tags -->
                <div>
                    <label class="block text-xs font-medium text-gray-600">Suggested Tags:</label>
                    <div id="suggested-tags-container" class="mt-2 flex flex-wrap gap-2">
                        <!-- Suggested tags will be rendered here by JS -->
                    </div>
                </div>

            </form>
            
            <div class="flex justify-end p-4 bg-gray-50 border-t border-gray-200">
                <button id="cancel-modal-btn" type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200 mr-2">Cancel</button>
                <button id="save-entry-btn" type="submit" form="entry-form" class="bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200">Save Entry</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="modal-content bg-white rounded-md shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-bold text-[#000f21] mb-2">Are you sure?</h3>
                <p class="text-gray-600 mb-4">Are you sure you want to delete this entry? This action cannot be undone.</p>
                <p id="delete-entry-title" class="text-base font-semibold text-gray-900 bg-gray-100 p-3 rounded-md mb-4"></p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition duration-200">Cancel</button>
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Notification -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-green-700 text-white py-2 px-5 rounded-md shadow-lg hidden z-50 transition-all duration-300 opacity-0 transform translate-y-2">
        <p id="notification-message">Success!</p>
    </div>

    <!-- Required for prose/markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Syntax Highlighting JS (for rendered code) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- New Editor: EasyMDE JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut,
            signInWithRedirect,
            getRedirectResult,
            OAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc,
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            where, 
            orderBy,
            limit,
            increment, 
            serverTimestamp,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Global State ---
        let db, auth, storage;
        let userId = null;
        let appId = 'default-app-id';
        let currentUserProfile = null;
        let userProfileDocRef = null; 
        
        let allEntries = [];
        let recentEntries = [];
        let popularLinks = []; 
        let currentFilter = { type: 'category', value: 'all' };
        let currentSelectedEntryId = null;
        let entryToDeleteId = null;
        let entriesCollectionRef = null;
        
        let easyMDE = null;

        // --- UI Elements ---
        const userIdDisplay = document.getElementById('user-id-display');
        const userNameDisplay = document.getElementById('user-name-display');
        
        // App containers
        const appHeader = document.getElementById('app-header');
        const appMain = document.getElementById('app-main');
        
        // Views
        const signInView = document.getElementById('sign-in-view');
        const homeView = document.getElementById('home-view');
        const listView = document.getElementById('list-view');
        const detailView = document.getElementById('detail-view');

        // Home View Elements
        const recentlyUpdatedList = document.getElementById('recently-updated-list');
        const myFavoritesList = document.getElementById('my-favorites-list');
        const popularLinksList = document.getElementById('popular-links-list'); 

        // List View Elements
        const listViewTitle = document.getElementById('list-view-title');
        const searchBar = document.getElementById('search-bar');
        const listViewEntries = document.getElementById('list-view-entries');

        // Detail View Elements
        const backToListBtn = document.getElementById('back-to-list-btn');
        const entryDetailContent = document.getElementById('entry-detail-content');
        
        // Modals
        const entryModal = document.getElementById('entry-modal');
        const entryModalContent = entryModal.querySelector('.modal-content');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalContent = deleteConfirmModal.querySelector('.modal-content');
        const modalTitle = document.getElementById('modal-title');
        const entryForm = document.getElementById('entry-form');
        const entryIdField = document.getElementById('entry-id-field');
        const entryTitle = document.getElementById('entry-title');
        const entryPinned = document.getElementById('entry-pinned');
        const entryCategory = document.getElementById('entry-category');
        const entryContent = document.getElementById('entry-content');
        const entryScript = document.getElementById('entry-script');
        const entryUrl = document.getElementById('entry-url');
        const entryTags = document.getElementById('entry-tags');
        const suggestedTagsContainer = document.getElementById('suggested-tags-container');
        const entryImageUpload = document.getElementById('entry-image-upload');
        const imageUploadStatus = document.getElementById('image-upload-status');
        
        // Modal Field Groups
        const fieldGroupContent = document.getElementById('field-group-content');
        const fieldGroupScript = document.getElementById('field-group-script');
        const fieldGroupLink = document.getElementById('field-group-link');
        
        // Buttons
        const addNewItemBtnHome = document.getElementById('add-new-item-btn-home');
        const addNewItemBtnList = document.getElementById('add-new-item-btn-list');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const saveEntryBtn = document.getElementById('save-entry-btn');
        const categoryFilterList = document.getElementById('category-filter-list');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const signInError = document.getElementById('sign-in-error');
        // Theme toggle elements removed
        
        // Notification
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');

        // --- Baked-in Tags ---
        const SUGGESTED_TAGS = [
            'vpn', 'printer', 'm365', 'azure', 'teams', 'outlook', 'email',
            'password', 'reset', 'onboarding', 'offboarding', 'network',
            'hardware', 'software', 'windows', 'macos'
        ];
        
        // --- Pin Icon SVG ---
        const pinIconSVG = `
            <svg class="w-4 h-4 mr-1.5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .68-.342 1.174-.63 1.472.288.3.63.792.63 1.472 0 .509-.211.961-.555 1.258a.5.5 0 0 1-.445.242H4.5a.5.5 0 0 1-.445-.242A1.49 1.49 0 0 1 3.5 14.5c0-.68.342-1.174.63-1.472-.288-.3-.63-.792-.63-1.472 0-.68.342-1.174.63-1.472-.288-.3-.63-.792-.63-1.472 0-.68.342-1.174.63-1.472-.288-.3-.63-.792-.63-1.472 0-.68.342-1.174.63-1.472-.288-.3-.63-.792-.63-1.472 0-.68.342-1.174.63-1.472-.288-.3-.63-.792-.63-1.472 0-.68.342-1.174.63-1.472A1.49 1.49 0 0 1 4.5 0zM5 1.5a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h6a.post.5 0 0 0 0-1H5z"/>
            </svg>
        `;

        // --- Firebase Initialization ---
        function initializeFirebase() {
            try {
                if (typeof __firebase_config === 'undefined') {
                    console.error("Firebase config is not defined.");
                    return;
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                
                if (typeof __app_id !== 'undefined') {
                    appId = __app_id;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                setupAuthListener();
                checkRedirectResult(); 
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // --- Authentication ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    
                    console.log("User authenticated:", user.uid);
                    
                    setupUserProfileListener(user);
                    
                    appHeader.classList.remove('hidden');
                    appMain.classList.remove('hidden');
                    signInView.classList.add('hidden');
                    
                    setupFirestoreListeners();
                    handleHashChange();
                    
                } else {
                    // User is signed out
                    userId = null;
                    currentUserProfile = null;
                    userProfileDocRef = null;
                    userIdDisplay.textContent = "Not signed in";
                    userNameDisplay.textContent = "";

                    appHeader.classList.add('hidden');
                    appMain.classList.add('hidden');
                    signInView.classList.add('hidden');
                    
                    allEntries = [];
                    listViewEntries.innerHTML = '';
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Attempting sign in with custom token...");
                        await attemptSignInWithToken();
                    } else {
                        // FOR TESTING:
                        console.log("No auth token. Attempting anonymous sign-in for testing.");
                        try {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will fire again
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            appHeader.classList.add('hidden');
                            appMain.classList.add('hidden');
                            signInView.classList.remove('hidden');
                            signInError.textContent = "Anonymous sign-in failed. (Is anonymous auth enabled in Firebase?)";
                            signInError.classList.remove('hidden');
                        }
                    }
                }
            });
        }
        
        /**
         * Listens to the user's profile doc for display name, favorites
         */
        function setupUserProfileListener(user) {
            if (userProfileDocRef) return; 

            const profileRef = doc(db, `/artifacts/${appId}/public/data/user_profiles`, user.uid);
            userProfileDocRef = profileRef; 

            onSnapshot(profileRef, async (docSnap) => {
                if (docSnap.exists()) {
                    currentUserProfile = docSnap.data();
                    console.log("User profile loaded:", currentUserProfile);
                } else {
                    // Profile doesn't exist, create it
                    console.log("No user profile found, creating one...");
                    
                    const newProfile = {
                        uid: user.uid,
                        displayName: user.displayName || (user.isAnonymous ? "Anonymous User" : `User ${user.uid.substring(0, 6)}...`),
                        email: user.email || '',
                        favorites: []
                        // theme property removed
                    };
                    try {
                        await setDoc(profileRef, newProfile);
                        currentUserProfile = newProfile;
                        console.log("User profile created:", currentUserProfile);
                    } catch (error) {
                        console.error("Error creating user profile:", error);
                    }
                }
                
                // Once profile is loaded or created, update UI
                if (currentUserProfile) {
                    userNameDisplay.textContent = currentUserProfile.displayName;
                }
                
                // Theme logic removed
                
                // Update favorites list and detail view (if open)
                renderFavoritesList();
                if (!detailView.classList.contains('hidden') && currentSelectedEntryId) {
                    renderDetailView(currentSelectedEntryId);
                }
            }, (error) => {
                console.error("Error listening to user profile:", error);
            });
        }

        async function attemptSignInWithToken() {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                appHeader.classList.add('hidden');
                appMain.classList.add('hidden');
                signInView.classList.remove('hidden');
                signInError.textContent = "Internal authentication failed. Please contact support.";
                signInError.classList.remove('hidden');
            }
        }

        async function handleSignIn() {
            signInBtn.disabled = true;
            signInBtn.textContent = 'Redirecting...';
            const provider = new OAuthProvider('microsoft.com');
            provider.setCustomParameters({
              tenant: 'YOUR_TENANT_ID' // e.g., 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
            });
            provider.addScope('user.read'); 
            try {
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Error starting sign-in redirect:", error);
                signInError.textContent = `Error: ${error.message}`;
                signInError.classList.remove('hidden');
                signInBtn.disabled = false;
                signInBtn.textContent = 'Sign in with Microsoft';
            }
        }

        async function checkRedirectResult() {
            if (auth) {
                try {
                    const result = await getRedirectResult(auth);
                    if (result) {
                        console.log("Sign-in redirect successful.", result.user);
                    }
                } catch (error) {
                    console.error("Error during sign-in redirect result:", error);
                    if (error.code === 'auth/account-exists-with-different-credential') {
                        signInError.textContent = 'An account already exists with this email using a different sign-in method.';
                    } else {
                        signInError.textContent = `Sign-in failed: ${error.message}`;
                    }
                    appHeader.classList.add('hidden');
                    appMain.classList.add('hidden');
                    signInView.classList.remove('hidden');
                    signInError.classList.remove('hidden');
                }
            }
        }
        
        async function handleSignOut() {
            try {
                await signOut(auth);
                window.location.hash = '#';
                console.log("User signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        }

        // --- Firestore Listeners ---
        function setupFirestoreListeners() {
            if (!db || !userId) {
                console.error("Firestore or UserID not ready for listener.");
                return;
            }
            
            const collectionPath = `/artifacts/${appId}/public/data/wiki_entries`;
            entriesCollectionRef = collection(db, collectionPath);
            
            // Listener 1: Get ALL entries
            const allEntriesQuery = query(entriesCollectionRef); 
            onSnapshot(allEntriesQuery, (snapshot) => {
                allEntries = [];
                snapshot.forEach((doc) => {
                    allEntries.push({ id: doc.id, ...doc.data() });
                });
                handleHashChange();
                renderFavoritesList();
            }, (error) => {
                console.error("Error listening to all entries:", error);
                listViewEntries.innerHTML = '<p class="text-red-400">Error loading entries.</p>';
            });
            
            // Listener 2: Get 5 MOST RECENTLY UPDATED
            const recentEntriesQuery = query(entriesCollectionRef, orderBy("updatedAt", "desc"), limit(5));
            onSnapshot(recentEntriesQuery, (snapshot) => {
                recentEntries = [];
                snapshot.forEach((doc) => {
                    recentEntries.push({ id: doc.id, ...doc.data() });
                });
                renderRecentEntries(); 
            }, (error) => {
                console.error("Error listening to recent entries:", error);
                recentlyUpdatedList.innerHTML = `<p class="text-red-500">Error loading recent entries. Please check the console (F12) for an error message from Firebase. You may need to create a database index.</p>`;
                console.error("If you see an error above about a missing index, please copy the link from the error message and open it in a new tab to create the required index in Firebase.");
            });
            
            // Listener 3: Get 5 MOST POPULAR LINKS
            const popularLinksQuery = query(entriesCollectionRef, 
                where("category", "==", "link"), 
                orderBy("clickCount", "desc"), 
                limit(5)
            );
            
            onSnapshot(popularLinksQuery, (snapshot) => {
                popularLinks = [];
                snapshot.forEach((doc) => {
                    popularLinks.push({ id: doc.id, ...doc.data() });
                });
                renderPopularLinks(); 
                
            }, (error) => {
                console.error("Error listening to popular links:", error);
                popularLinksList.innerHTML = `<p class="text-red-500">Error loading popular links. Please check the console (F12) for an error message from Firebase. You may need to create a database index.</p>`;
                console.error("If you see an error above about a missing index (for 'clickCount'), please copy the link from the error message and open it in a new tab to create the required index in Firebase.");
            });
        }
        
        // --- Router (Hash Change Handler) ---
        function handleHashChange() {
            if (!userId) {
                appHeader.classList.add('hidden');
                appMain.classList.add('hidden');
                signInView.classList.remove('hidden');
                return;
            }
            
            const hash = window.location.hash || '#';
            
            homeView.classList.add('hidden');
            listView.classList.add('hidden');
            detailView.classList.add('hidden');
            
            if (hash.startsWith('#detail/')) {
                const id = hash.split('/')[1];
                renderDetailView(id);
                detailView.classList.remove('hidden');
            } else if (hash.startsWith('#list/')) {
                const parts = hash.split('/');
                const filterType = parts[1];
                const filterValue = parts[2] || 'all'; 
                
                if (filterType === 'all') {
                    currentFilter = { type: 'category', value: 'all' };
                } else if (filterType === 'tag') {
                    currentFilter = { type: 'tag', value: filterValue };
                } else {
                    currentFilter = { type: 'category', value: filterType };
                }
                
                renderListView();
                listView.classList.remove('hidden');
            } else {
                // Default to home
                currentFilter = { type: 'category', value: 'all' };
                homeView.classList.remove('hidden');
                searchBar.value = '';
                document.querySelectorAll('#home-card-grid .home-card').forEach((card, index) => {
                    card.style.animationDelay = `${index * 100}ms`;
                    card.classList.add('animate-slide-in-up');
                });
                
                renderFavoritesList();
                renderRecentEntries();
                renderPopularLinks(); 
            }
        }

        // --- Rendering ---
        
        /**
         * Renders the "Popular Links" list on the home page
         */
        function renderPopularLinks() {
            if (popularLinks.length === 0) {
                popularLinksList.innerHTML = `<p class="text-gray-500 text-center">No links have been clicked yet.</p>`;
                return;
            }
            
            popularLinksList.innerHTML = popularLinks.map(entry => {
                return `
                <a href="#detail/${entry.id}" 
                   class="entry-list-item block p-4 rounded-md transition duration-150 bg-white hover:bg-gray-50 shadow-sm border border-gray-200 opacity-0"
                   data-id="${entry.id}">
                    <h3 class="flex items-center text-lg font-semibold text-[#000f21]">
                        ${entry.isPinned ? pinIconSVG : ''}
                        ${entry.title || 'Untitled Entry'}
                    </h3>
                    <span class_class="text-xs text-gray-500 truncate">${entry.url || '...'}</span>
                </a>
            `;
            }).join('');
            
            document.querySelectorAll('#popular-links-list .entry-list-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.animationDelay = `${index * 75}ms`;
                    item.classList.add('animate-slide-in-up');
                }, 0);
            });
        }
        
        /**
         * Renders the "My Favorites" list on the home page
         */
        function renderFavoritesList() {
            if (!currentUserProfile) {
                myFavoritesList.innerHTML = `<p class="text-gray-500">Loading favorites...</p>`;
                return;
            }
            
            const favoriteIds = currentUserProfile.favorites || [];
            if (favoriteIds.length === 0) {
                myFavoritesList.innerHTML = `<p class="text-gray-500 text-center">You haven't favorited any entries yet. Click the star (&#9734;) on an entry to add it here.</p>`;
                return;
            }
            
            const favoriteEntries = allEntries.filter(entry => favoriteIds.includes(entry.id));
            favoriteEntries.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            
            myFavoritesList.innerHTML = favoriteEntries.map(entry => {
                return `
                <a href="#detail/${entry.id}" 
                   class="entry-list-item block p-4 rounded-md transition duration-150 bg-white hover:bg-gray-50 shadow-sm border border-gray-200 opacity-0"
                   data-id="${entry.id}">
                    <h3 class="flex items-center text-lg font-semibold text-[#000f21]">
                        ${entry.isPinned ? pinIconSVG : ''}
                        ${entry.title || 'Untitled Entry'}
                    </h3>
                    <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-xs font-semibold mt-1">${entry.category.toUpperCase()}</span>
                </a>
            `;
            }).join('');
            
            document.querySelectorAll('#my-favorites-list .entry-list-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.animationDelay = `${index * 75}ms`;
                    item.classList.add('animate-slide-in-up');
                }, 0);
            });
        }

        /**
         * Renders the "Recently Updated" list on the home page
         */
        function renderRecentEntries() {
            if (recentEntries.length === 0) {
                if (allEntries.length === 0) {
                    recentlyUpdatedList.innerHTML = `<p class="text-gray-500 text-center">No entries yet. Add one!</p>`;
                } else {
                    recentlyUpdatedList.innerHTML = `<p class="text-gray-500 text-center">Loading...</p>`;
                }
                return;
            }
            
            recentlyUpdatedList.innerHTML = recentEntries.map(entry => {
                const updated = entry.updatedAt ? new Date(entry.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A';
                return `
                <a href="#detail/${entry.id}" 
                   class="entry-list-item block p-4 rounded-md transition duration-150 bg-white hover:bg-gray-50 shadow-sm border border-gray-200 opacity-0"
                   data-id="${entry.id}">
                    <div class="flex justify-between items-center">
                        <h3 class="flex items-center text-lg font-semibold text-[#000f21]">
                            ${entry.isPinned ? pinIconSVG : ''}
                            ${entry.title || 'Untitled Entry'}
                        </h3>
                        <span class="text-sm text-gray-500">${updated}</span>
                    </div>
                    <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-xs font-semibold mt-1">${entry.category.toUpperCase()}</span>
                </a>
            `;
            }).join('');
            
            document.querySelectorAll('#recently-updated-list .entry-list-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.animationDelay = `${index * 75}ms`;
                    item.classList.add('animate-slide-in-up');
                }, 0);
            });
        }
        
        /**
         * Renders the List View based on the currentFilter state
         */
        function renderListView() {
            const categoryTitles = {
                all: 'All Entries',
                fix: 'Fixes',
                guide: 'Guides',
                config: 'Configs & Scripts',
                link: 'Useful Links'
            };
            
            if (currentFilter.type === 'category') {
                listViewTitle.textContent = categoryTitles[currentFilter.value] || 'All Entries';
            } else if (currentFilter.type === 'tag') {
                listViewTitle.textContent = `Showing Tag: "${currentFilter.value}"`;
            }
            
            const searchTerm = searchBar.value.toLowerCase();
            
            let filteredEntries = allEntries.filter(entry => {
                let categoryMatch = false;
                if (currentFilter.type === 'category') {
                    categoryMatch = (currentFilter.value === 'all' || entry.category === currentFilter.value);
                } else if (currentFilter.type === 'tag') {
                    categoryMatch = (entry.tags && entry.tags.includes(currentFilter.value));
                }

                const searchMatch = (
                    !searchTerm || 
                    (entry.title && entry.title.toLowerCase().includes(searchTerm)) ||
                    (entry.content && entry.content.toLowerCase().includes(searchTerm)) ||
                    (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
                return categoryMatch && searchMatch;
            });
            
            filteredEntries.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                const titleA = a.title ? a.title.toLowerCase() : '';
                const titleB = b.title ? b.title.toLowerCase() : '';
                if (titleA < titleB) return -1;
                if (titleA > titleB) return 1;
                return 0;
            });
            
            if (filteredEntries.length === 0) {
                if (searchTerm) {
                    listViewEntries.innerHTML = `<p class="text-gray-500 text-center">No entries match your search.</p>`;
                } else {
                    let message = "No entries in this category yet. Add one!";
                    if(currentFilter.type === 'tag') {
                         message = "No entries found with this tag.";
                    }
                    listViewEntries.innerHTML = `<p class="text-gray-500 text-center">${message}</p>`;
                }
                return;
            }

            listViewEntries.innerHTML = filteredEntries.map(entry => `
                <a href="#detail/${entry.id}" 
                   class="entry-list-item block p-4 rounded-md transition duration-150 bg-white hover:bg-gray-50 shadow-sm border border-gray-200 opacity-0"
                   data-id="${entry.id}">
                    <h3 class="flex items-center text-lg font-semibold text-[#000f21]">
                        ${entry.isPinned ? pinIconSVG : ''}
                        ${entry.title || 'Untitled Entry'}
                    </h3>
                    <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-xs font-semibold mt-1">${entry.category.toUpperCase()}</span>
                </a>
            `).join('');
            
            document.querySelectorAll('.entry-list-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.animationDelay = `${index * 75}ms`;
                    item.classList.add('animate-slide-in-up');
                }, 0); 
            });
        }
        
        /**
         * Renders the full details of a selected entry in the Detail View
         */
        function renderDetailView(entryId) {
            const entry = allEntries.find(e => e.id === entryId);
            
            if (!entry) {
                window.location.hash = '#';
                return;
            }
            
            currentSelectedEntryId = entry.id;
            
            if (currentFilter.type === 'category') {
                backToListBtn.href = `#list/${currentFilter.value}`;
            } else if (currentFilter.type === 'tag') {
                backToListBtn.href = `#list/tag/${currentFilter.value}`;
            } else {
                backToListBtn.href = `#list/all`;
            }
            
            let contentHtml = '';
            
            if (entry.category === 'fix' || entry.category === 'guide') {
                if (entry.content) {
                    contentHtml += `<div class="prose-custom prose-lg max-w-none">${marked.parse(entry.content)}</div>`;
                } else {
                    contentHtml += `<p class="text-gray-500 italic">No content provided for this entry.</p>`;
                }
            }
            
            if (entry.category === 'config') {
                if (entry.scriptOrConfigContent) {
                    let langClass = '';
                    const titleLower = entry.title.toLowerCase();
                    if (titleLower.includes('ps1') || titleLower.includes('powershell')) langClass = 'language-powershell';
                    else if (titleLower.includes('sh') || titleLower.includes('bash')) langClass = 'language-bash';
                    else if (titleLower.includes('json')) langClass = 'language-json';
                    else if (titleLower.includes('yml') || titleLower.includes('yaml')) langClass = 'language-yaml';
                    else if (titleLower.includes('ini')) langClass = 'language-ini';
                    
                    const escapedScript = entry.scriptOrConfigContent
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                    
                    contentHtml += `
                        <h3 class="text-xl font-semibold text-[#000f21] mb-2">Script/Config Content</h3>
                        <p class="text-sm text-gray-500 mb-4">You can copy the content below.</p>
                        <div class="relative">
                            <button class="copy-script-btn absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium py-1 px-2 rounded-md transition z-10">Copy</button>
                            <pre class="prose-custom"><code class="${langClass}">${escapedScript}</code></pre>
                        </div>`;
                } else {
                    contentHtml += `<p class="text-gray-500 italic">No script or config content provided.</p>`;
                }
            }
            
            if (entry.category === 'link') {
                if (entry.url) {
                    contentHtml += `
                        <h3 class="text-xl font-semibold text-[#000f21] mb-2">Useful Link</h3>
                        <a href="${entry.url}" target="_blank" rel="noopener noreferrer" data-id="${entry.id}" class="text-green-700 hover:text-green-800 text-lg underline break-all">
                            ${entry.url}
                        </a>
                        <p class="text-gray-600 mt-2">(Opens in a new tab)</p>
                    `;
                } else {
                    contentHtml += `<p class="text-gray-500 italic">No URL provided for this link.</p>`;
                }
            }
            
            let tagsHtml = '';
            if (entry.tags && entry.tags.length > 0) {
                tagsHtml = `
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">Tags:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${entry.tags.map(tag => `
                                <a href="#list/tag/${tag}" class="tag-pill bg-green-100 text-green-800 hover:bg-green-200 text-xs font-medium px-3 py-1 rounded-full transition-colors duration-150">${tag}</a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            const createdBy = entry.createdBy || 'Unknown User';
            const createdAt = entry.createdAt ? new Date(entry.createdAt.seconds * 1000).toLocaleString() : 'Unknown date';
            
            let updatedHtml = '';
            if (entry.updatedAt && entry.lastUpdatedBy) {
                const updatedAt = new Date(entry.updatedAt.seconds * 1000).toLocaleString();
                const updatedBy = entry.lastUpdatedBy;
                updatedHtml = `<span>&bull; Last updated ${updatedAt} by ${updatedBy}</span>`;
            }

            const isFavorite = currentUserProfile?.favorites?.includes(entry.id);
            const favoriteClass = isFavorite ? 'is-favorite' : '';
            const favoriteIcon = isFavorite ? '&#9733;' : '&#9734;'; 
            const favoriteTitle = isFavorite ? 'Remove from favorites' : 'Add to favorites';

            entryDetailContent.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 class="flex items-center text-4xl font-bold text-[#000f21] mb-2">
                            ${entry.isPinned ? pinIconSVG.replace('w-4 h-4', 'w-7 h-7') : ''}
                            ${entry.title || 'Untitled Entry'}
                        </h1>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500">
                            <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-xs font-semibold">${entry.category.toUpperCase()}</span>
                            <span>Created ${createdAt} by ${createdBy}</span>
                            ${updatedHtml}
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <button id="favorite-entry-btn" data-id="${entry.id}" title="${favoriteTitle}" class="favorite-btn ${favoriteClass}">
                            ${favoriteIcon}
                        </button>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="edit-entry-btn" data-id="${entry.id}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200">Edit</button>
                            <button id="delete-entry-btn" data-id="${entry.id}" data-title="${entry.title || 'Untitled Entry'}" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200">Delete</button>
                        </div>
                    </div>
                </div>
                <hr class="border-gray-200 my-6">
                ${contentHtml}
                ${tagsHtml}
            `;
            
            try {
                entryDetailContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } catch (error) {
                console.error("Error applying syntax highlighting:", error);
            }
        }

        /**
         * Renders the suggested tags in the modal
         */
        function renderSuggestedTags() {
            suggestedTagsContainer.innerHTML = SUGGESTED_TAGS.map(tag => 
                `<button type="button" data-tag="${tag}" class="suggested-tag-btn bg-gray-200 text-gray-700 hover:bg-gray-300 text-xs font-medium px-3 py-1 rounded-full transition-colors duration-150">${tag}</button>`
            ).join('');
        }

        /**
         * Handles clicking a suggested tag button
         */
        function handleSuggestedTagClick(e) {
            e.preventDefault();
            const target = e.target.closest('.suggested-tag-btn');
            if (!target) return;

            const tagToAdd = target.dataset.tag;
            const currentTags = entryTags.value.split(',')
                .map(t => t.trim())
                .filter(t => t.length > 0);

            if (!currentTags.includes(tagToAdd)) {
                currentTags.push(tagToAdd);
                entryTags.value = currentTags.join(', ');
            }
        }
        
        /**
         * Updates the modal form to show/hide fields based on selected category
         */
        function updateModalFields() {
            const category = entryCategory.value;
            
            fieldGroupContent.classList.add('hidden');
            fieldGroupScript.classList.add('hidden');
            fieldGroupLink.classList.add('hidden');
            
            if (category === 'fix' || category === 'guide') {
                fieldGroupContent.classList.remove('hidden');
            } else if (category === 'config') {
                fieldGroupScript.classList.remove('hidden');
            } else if (category === 'link') {
                fieldGroupLink.classList.remove('hidden');
            }
        }
        
        /**
         * Opens the modal, either for a new entry or to edit an existing one
         */
        function openModal(mode = 'add', entry = null, prefillCategory = null) {
            entryForm.reset();
            
            if (mode === 'edit' && entry) {
                modalTitle.textContent = 'Edit Entry';
                entryIdField.value = entry.id;
                entryTitle.value = entry.title || '';
                entryPinned.checked = entry.isPinned || false;
                entryCategory.value = entry.category || 'fix';
                entryScript.value = entry.scriptOrConfigContent || '';
                entryUrl.value = entry.url || '';
                entryTags.value = (entry.tags && entry.tags.join(', ')) || '';
            } else {
                modalTitle.textContent = 'Add New Entry';
                entryIdField.value = ''; 
                entryPinned.checked = false;
                entryTags.value = '';
                if (prefillCategory && prefillCategory !== 'all' && currentFilter.type === 'category') {
                    entryCategory.value = prefillCategory;
                }
            }

            renderSuggestedTags();
            
            imageUploadStatus.textContent = 'Select an image to upload. It will be automatically added to the content area.';
            imageUploadStatus.classList.remove('text-red-500', 'text-green-500');
            entryImageUpload.value = '';

            updateModalFields(); 
            
            entryModal.classList.remove('hidden');
            entryModal.classList.remove('modal-backdrop-out');
            entryModalContent.classList.remove('modal-content-out');

            setTimeout(() => {
                if (!easyMDE) {
                    easyMDE = new EasyMDE({
                        element: document.getElementById('entry-content'),
                        spellChecker: false,
                        autoDownloadFontAwesome: false, 
                        toolbar: [
                            "bold", "italic", "strikethrough", "|", 
                            "code", "quote", "link", "image", "|", 
                            "unordered-list", "ordered-list", "table", "|", 
                            "preview", "side-by-side", "fullscreen", "|", 
                            "guide"
                        ],
                        renderingConfig: {
                            codeSyntaxHighlighting: true,
                            markedOptions: {
                                gfm: true,
                                breaks: true,
                            }
                        }
                    });
                }
                
                if (mode === 'edit' && entry) {
                    easyMDE.value(entry.content || '');
                } else {
                    easyMDE.value('');
                }
            }, 50); 
        }
        
        /**
         * Closes the main modal
         */
        function closeModal() {
            entryModal.classList.add('modal-backdrop-out');
            entryModalContent.classList.add('modal-content-out');
            
            setTimeout(() => {
                entryModal.classList.add('hidden');
                entryModal.classList.remove('modal-backdrop-out');
                entryModalContent.classList.remove('modal-content-out');

                if (easyMDE) {
                    easyMDE.toTextArea();
                    easyMDE = null;
                }
                entryForm.reset();
                imageUploadStatus.textContent = 'Select an image to upload. It will be automatically added to the content area.';
                imageUploadStatus.classList.remove('text-red-500', 'text-green-500');
                entryImageUpload.value = '';
            }, 200); 
        }
        
        /**
         * Opens the delete confirmation modal
         */
        function openDeleteConfirm(id, title) {
            entryToDeleteId = id;
            document.getElementById('delete-entry-title').textContent = title;
            deleteConfirmModal.classList.remove('hidden');
            deleteConfirmModal.classList.remove('modal-backdrop-out');
            deleteModalContent.classList.remove('modal-content-out');
        }
        
        /**
         * Closes the delete confirmation modal
         */
        function closeDeleteConfirm() {
            deleteConfirmModal.classList.add('modal-backdrop-out');
            deleteModalContent.classList.add('modal-content-out');
            
            setTimeout(() => {
                deleteConfirmModal.classList.add('hidden');
                deleteConfirmModal.classList.remove('modal-backdrop-out');
                deleteModalContent.classList.remove('modal-content-out');
                entryToDeleteId = null;
            }, 200); 
        }
        
        /**
         * Shows a success notification
         */
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationToast.classList.remove('hidden');
            setTimeout(() => {
                notificationToast.classList.remove('opacity-0', 'translate-y-2');
            }, 10); 
            
            setTimeout(() => {
                notificationToast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    notificationToast.classList.add('hidden');
                }, 300); 
            }, 3000); 
        }
        
        // Theme functions removed

        // --- Event Handlers ---
        
        // Theme toggle handler removed
        
        /**
         * Main Save logic (Create or Update)
         */
        async function handleSaveEntry(e) {
            e.preventDefault();
            if (!userId || !currentUserProfile) {
                console.error("Cannot save, user or profile not authenticated.");
                showNotification("Error: Not authenticated.");
                return;
            }

            saveEntryBtn.disabled = true;
            saveEntryBtn.textContent = 'Saving...';

            const entryId = entryIdField.value;
            
            const tagsArray = entryTags.value
                .split(',')
                .map(tag => tag.trim().toLowerCase()) 
                .filter(tag => tag.length > 0);

            const data = {
                title: entryTitle.value,
                category: entryCategory.value,
                content: easyMDE.value(), 
                scriptOrConfigContent: entryScript.value,
                url: entryUrl.value,
                isPinned: entryPinned.checked,
                tags: tagsArray,
                title_lowercase: entryTitle.value.toLowerCase(),
                updatedAt: serverTimestamp() 
            };
            
            try {
                let docId = entryId;
                if (entryId) {
                    // Update
                    const docRef = doc(db, `/artifacts/${appId}/public/data/wiki_entries`, entryId);
                    await setDoc(docRef, { 
                        ...data,
                        lastUpdatedBy: currentUserProfile.displayName
                    }, { merge: true }); 
                    showNotification("Entry updated successfully!");
                } else {
                    // Create
                    if (data.category === 'link') {
                        data.clickCount = 0;
                    }
                    const docRef = await addDoc(entriesCollectionRef, {
                        ...data,
                        createdBy: currentUserProfile.displayName,
                        createdAt: serverTimestamp()
                    });
                    docId = docRef.id; 
                    showNotification("Entry added successfully!");
                }
                
                closeModal();
                window.location.hash = `#detail/${docId}`;
                
            } catch (error) {
                console.error("Error saving entry:", error);
                showNotification("Error saving entry.");
            } finally {
                saveEntryBtn.disabled = false;
                saveEntryBtn.textContent = 'Save Entry';
            }
        }
        
        /**
         * Main Delete logic
         */
        async function handleDeleteEntry() {
            if (!entryToDeleteId) return;

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Deleting...';
            
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/wiki_entries`, entryToDeleteId);
                await deleteDoc(docRef);
                
                if (userProfileDocRef && currentUserProfile?.favorites?.includes(entryToDeleteId)) {
                    await updateDoc(userProfileDocRef, {
                        favorites: arrayRemove(entryToDeleteId)
                    });
                }
                
                showNotification("Entry deleted successfully.");
                
                if (currentFilter.type === 'category') {
                    window.location.hash = `#list/${currentFilter.value}`;
                } else if (currentFilter.type === 'tag') {
                    window.location.hash = `#list/tag/${currentFilter.value}`;
                } else {
                    window.location.hash = `#list/all`;
                }
                
            } catch (error) {
                console.error("Error deleting entry:", error);
                showNotification("Error deleting entry.");
            } finally {
                closeDeleteConfirm();
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = 'Delete';
            }
        }
        
        /**
         * Uploads an image to Firebase Storage and inserts the link into the editor
         */
        async function handleImageUpload() {
            const file = entryImageUpload.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                imageUploadStatus.textContent = 'Error: Only image files are allowed.';
                imageUploadStatus.classList.add('text-red-500');
                return;
            }
            if (!storage || !userId) {
                imageUploadStatus.textContent = 'Error: Not ready to upload.';
                imageUploadStatus.classList.add('text-red-500');
                return;
            }

            imageUploadStatus.textContent = 'Uploading image...';
            imageUploadStatus.classList.remove('text-red-500', 'text-green-500');

            try {
                const fileName = `${crypto.randomUUID()}-${file.name}`;
                const storageRef = ref(storage, `/artifacts/${appId}/public/data/wiki_images/${fileName}`);
                
                const uploadResult = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(uploadResult.ref);
                
                const markdownImage = `\n![${file.name}](${downloadURL})\n`;
                
                if (easyMDE) {
                    easyMDE.codemirror.replaceSelection(markdownImage);
                } else {
                    entryContent.value += markdownImage;
                }
                
                imageUploadStatus.textContent = 'Success! Image added to content.';
                imageUploadStatus.classList.add('text-green-500');
                entryImageUpload.value = ''; 
                
            } catch (error) {
                console.error("Error uploading image:", error);
                imageUploadStatus.textContent = 'Error uploading image. See console.';
                imageUploadStatus.classList.add('text-red-500');
            }
        }
        
        /**
         * Toggles an entry in the user's favorites list
         */
        async function handleToggleFavorite(entryId) {
            if (!userProfileDocRef || !currentUserProfile) {
                console.error("User profile not loaded, cannot toggle favorite.");
                return;
            }
            
            const isFavorite = currentUserProfile.favorites?.includes(entryId);
            
            try {
                if (isFavorite) {
                    await updateDoc(userProfileDocRef, {
                        favorites: arrayRemove(entryId)
                    });
                    showNotification("Removed from favorites.");
                } else {
                    await updateDoc(userProfileDocRef, {
                        favorites: arrayUnion(entryId)
                    });
                    showNotification("Added to favorites!");
                }
            } catch (error) {
                console.error("Error toggling favorite:", error);
                showNotification("Error updating favorites.");
            }
        }
        
        /**
         * Increments the click count for a link
         */
        async function incrementLinkClickCount(entryId) {
            if (!db) return;
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/wiki_entries`, entryId);
                await updateDoc(docRef, {
                    clickCount: increment(1)
                });
                console.log("Incremented click count for", entryId);
            } catch (error) {
                console.error("Error incrementing click count:", error);
            }
        }
        
        /**
         * Handle dynamic clicks in the main content area (Edit, Delete, Copy, Tag, Favorite, Link)
         */
        detailView.addEventListener('click', (e) => {
            const editBtn = e.target.closest('#edit-entry-btn');
            const deleteBtn = e.target.closest('#delete-entry-btn');
            const copyBtn = e.target.closest('.copy-script-btn');
            const tagPill = e.target.closest('.tag-pill');
            const favoriteBtn = e.target.closest('#favorite-entry-btn'); 
            const detailLink = e.target.closest('a[target="_blank"][data-id]'); 

            if (editBtn) {
                const entryId = editBtn.dataset.id;
                const entry = allEntries.find(e => e.id === entryId);
                if (entry) {
                    openModal('edit', entry);
                }
                return;
            }
            
            if (deleteBtn) {
                const entryId = deleteBtn.dataset.id;
                const entryTitle = deleteBtn.dataset.title;
                openDeleteConfirm(entryId, entryTitle);
                return;
            }
            
            if (copyBtn) {
                const pre = copyBtn.nextElementSibling;
                const code = pre.querySelector('code');
                if (code) {
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = code.textContent;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => (copyBtn.textContent = 'Copy'), 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        copyBtn.textContent = 'Failed!';
                        setTimeout(() => (copyBtn.textContent = 'Copy'), 2000);
                    }
                }
                return;
            }
            
            if (favoriteBtn) { 
                const entryId = favoriteBtn.dataset.id;
                handleToggleFavorite(entryId);
                return;
            }
            
            if (detailLink) { 
                incrementLinkClickCount(detailLink.dataset.id);
                return;
            }

            if(tagPill) {
                return;
            }
        });
        
        appMain.addEventListener('click', (e) => {
            const listItem = e.target.closest('.entry-list-item[data-id]');
            if (!listItem) return;
            
            const entryId = listItem.dataset.id;
            const entry = allEntries.find(e => e.id === entryId);
            
            if (entry && entry.category === 'link') {
                incrementLinkClickCount(entryId);
            }
        });
        
        // Modal general listeners
        addNewItemBtnHome.addEventListener('click', () => openModal('add'));
        addNewItemBtnList.addEventListener('click', () => {
            const prefill = currentFilter.type === 'category' ? currentFilter.value : null;
            openModal('add', null, prefill);
        });
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        entryCategory.addEventListener('change', updateModalFields);
        entryForm.addEventListener('submit', handleSaveEntry);
        suggestedTagsContainer.addEventListener('click', handleSuggestedTagClick);
        
        // Auth listeners
        signInBtn.addEventListener('click', handleSignIn);
        signOutBtn.addEventListener('click', handleSignOut);
        // themeToggleBtn listener removed
        
        // Editor listeners
        entryImageUpload.addEventListener('change', handleImageUpload);
        
        // Delete confirm listeners
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirm);
        confirmDeleteBtn.addEventListener('click', handleDeleteEntry);

        // Copy User ID
        userIdDisplay.addEventListener('click', () => {
            if (userId) {
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = userId;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('User ID copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy User ID: ', err);
                }
            }
        });

        // Search bar listener
        searchBar.addEventListener('input', () => {
            const hash = window.location.hash;
            if (!hash.startsWith('#list/')) {
                window.location.hash = '#list/all';
            } else {
                renderListView();
            }
        });
        
        // --- Router Listener ---
        window.addEventListener('hashchange', handleHashChange);

        // --- Start the App ---
        initializeFirebase();
        
    </script>
</body>
</html>

