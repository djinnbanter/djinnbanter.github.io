<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Mod Factory Builder - Feedback</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass-dark: #71512E;
            --brass: #a97a4a;
            --brass-light: #D6A46E;
            --dark-metal: #2E2F34;
            --dark-metal-border: #1E1F22;
            --panel-bg: #3a3f4b;
            --accent-cyan: #0891b2;
            --rivet-color: #2c303a;
            --canvas-bg-color: #1a1a1a;
        }
        body {
            font-family: 'Roboto Slab', serif;
            background-color: var(--canvas-bg-color);
            background-image:
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .plate {
            position: relative;
            font-weight: 700;
            color: white;
            border-radius: 0.25rem;
            border: 1px solid var(--dark-metal-border);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 2px 4px rgba(0,0,0,0.5);
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }
        .rivet {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: var(--rivet-color);
            border-radius: 50%;
            box-shadow: inset 0 1px 1px rgba(0,0,0,0.5);
            border: 1px solid #1a1c20;
        }
        .rivet.top-left { top: 4px; left: 4px; }
        .rivet.top-right { top: 4px; right: 4px; }
        .rivet.bottom-left { bottom: 4px; left: 4px; }
        .rivet.bottom-right { bottom: 4px; right: 4px; }
        .btn-plate:hover {
            filter: brightness(1.2);
        }
        .comment-card, .form-card {
            background-color: var(--panel-bg);
            border: 2px solid var(--dark-metal-border);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .comment-reply {
            border-left: 4px solid var(--brass);
            background-color: rgba(46, 47, 52, 0.5);
        }
        .category-tag {
            display: flex;
            align-items: center;
            padding: 2px 10px;
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            border-radius: 0.25rem;
            border: 1px solid var(--brass-dark);
            background-image: linear-gradient(to bottom, var(--brass-light), var(--brass));
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.2);
            line-height: 1.5;
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-cyan-400" style="text-shadow: 0 0 10px var(--accent-cyan);">Factory Builder Feedback</h1>
            <p class="text-gray-400 mt-2 text-lg">Help shape the future of the planner!</p>
            <p id="admin-status" class="hidden text-center text-cyan-400 font-bold mt-4"></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Feedback Submission Form -->
            <aside class="lg:col-span-1">
                <div class="form-card rounded-lg p-6 sticky top-8">
                    <h2 class="text-2xl font-bold text-white border-b-2 border-gray-700 pb-3 mb-4">Leave a Comment</h2>
                    <form id="feedback-form">
                        <div class="mb-4">
                            <label for="username" class="block text-gray-300 mb-2">Username</label>
                            <input type="text" id="username" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                        <div class="mb-4">
                            <label for="category" class="block text-gray-300 mb-2">Category</label>
                            <select id="category" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                <option>Suggestion</option>
                                <option>Bug Report</option>
                                <option>Praise</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="comment" class="block text-gray-300 mb-2">Comment</label>
                            <textarea id="comment" rows="5" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></textarea>
                        </div>
                        <button type="submit" id="submit-btn" class="w-full btn-plate font-bold py-2 px-4 transition-colors text-center plate" style="background-image: linear-gradient(to bottom, #22c55e, #166534);">
                            <div class="rivet top-left"></div><div class="rivet top-right"></div>
                            Submit Feedback
                            <div class="rivet bottom-left"></div><div class="rivet bottom-right"></div>
                        </button>
                    </form>
                </div>
            </aside>

            <!-- Community Feedback Section -->
            <section class="lg:col-span-2">
                <h2 class="text-3xl font-bold text-white mb-6">Community Feedback</h2>
                <div id="feedback-list" class="space-y-6">
                    <!-- Loading state -->
                    <p id="loading-state" class="text-gray-400">Connecting to feedback service...</p>
                    <!-- Error state -->
                    <p id="error-state" class="hidden text-red-400"></p>
                    <!-- Empty state -->
                    <p id="empty-state" class="hidden text-gray-400">No feedback yet. Be the first to leave a comment!</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setDoc, getDocs, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8VmlJpkvoljn42deVT9PU3uDfV2zMVmY",
            authDomain: "factorybuilderfeedback.firebaseapp.com",
            projectId: "factorybuilderfeedback",
            storageBucket: "factorybuilderfeedback.firebasestorage.app",
            messagingSenderId: "523884151318",
            appId: "1:523884151318:web:7ed25d016866e8b4bb2b37"
        };
        const ADMIN_UID = "gzY4snJU2LMqE0MsMkThHjTVZhA2"; // IMPORTANT!
        const appId = "factorybuilderfeedback";
        let app, db, auth;

        // --- DOM ELEMENTS ---
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackList = document.getElementById('feedback-list');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const emptyState = document.getElementById('empty-state');
        const adminStatus = document.getElementById('admin-status');

        // --- INITIALIZATION ---
        const init = () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    // Use a short timeout. This helps prevent a race condition on page load
                    // where the UI might render before Firebase has fully initialized the auth state after a login/reload.
                    setTimeout(() => {
                        const currentUser = auth.currentUser; // Get the most up-to-date user
                        if (currentUser) {
                            updateAdminUI(currentUser);
                            listenForFeedback(auth);
                        } else {
                            signInAnonymously(auth).catch(error => {
                                let message = "Could not connect to the feedback service. Please try again later.";
                                if (error.code === 'auth/configuration-not-found') {
                                    message = "Authentication error: Anonymous Sign-In is likely not enabled in your Firebase project. Please go to your Firebase Console -> Authentication -> Sign-in method, and enable 'Anonymous' sign-in. Link: https://console.firebase.google.com/project/_/authentication/providers";
                                }
                                console.error("Anonymous sign-in failed:", error);
                                showError(message);
                            });
                        }
                    }, 200); // 200ms delay should be sufficient
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Could not initialize the feedback service. Invalid configuration.");
            }
        };

        // --- UI RENDERING ---
        const updateAdminUI = (user) => {
             if (user && user.uid === ADMIN_UID) {
                adminStatus.textContent = 'Admin Mode Active';
                adminStatus.classList.remove('hidden');
            } else {
                adminStatus.classList.add('hidden');
            }
        }

        const showError = (message) => {
            loadingState.classList.add('hidden');
            emptyState.classList.add('hidden');
            errorState.textContent = message;
            errorState.classList.remove('hidden');
        };

        const showReplyForm = (feedbackId, commentContainer) => {
            const existingForm = commentContainer.querySelector('.reply-form-container');
            if (existingForm) {
                existingForm.remove();
                return;
            }
            
            const replyFormContainer = document.createElement('div');
            replyFormContainer.className = 'reply-form-container mt-4';
            replyFormContainer.innerHTML = `
                <textarea class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" rows="3" placeholder="Write your reply..."></textarea>
                <div class="flex justify-end gap-2 mt-2">
                     <button class="cancel-reply-btn text-sm py-1 px-3 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Cancel</button>
                    <button class="submit-reply-btn text-sm py-1 px-3 rounded-md bg-cyan-600 hover:bg-cyan-500 transition-colors">Submit Reply</button>
                </div>
            `;
            
            commentContainer.appendChild(replyFormContainer);
            
            replyFormContainer.querySelector('.submit-reply-btn').onclick = () => {
                const replyText = replyFormContainer.querySelector('textarea').value;
                if(replyText.trim()){
                    submitReply(feedbackId, replyText, commentContainer);
                }
            };
            replyFormContainer.querySelector('.cancel-reply-btn').onclick = () => {
                 replyFormContainer.remove();
            };
        };
        
        const renderComment = (doc, auth) => {
            const data = doc.data();
            const commentId = doc.id;
            const card = document.createElement('div');
            card.className = 'comment-card rounded-lg p-5';
            card.id = `comment-${commentId}`;

            const formattedDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Just now';
            
            const iconMap = {
                'Suggestion': '💡',
                'Bug Report': '🐞',
                'Praise': '👍',
                'Other': '💬'
            };
            const categoryIcon = iconMap[data.category] || '💬';

            let adminControls = '';
            if (auth.currentUser && auth.currentUser.uid === ADMIN_UID) {
                adminControls = `<button class="reply-btn text-sm font-bold text-cyan-400 hover:text-cyan-300 transition-colors">Reply</button>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg text-white">${data.username || 'Anonymous'}</p>
                        <p class="text-sm text-gray-400">${formattedDate}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="category-tag">
                           <span class="mr-2">${categoryIcon}</span><span>${data.category}</span>
                        </div>
                        ${adminControls}
                    </div>
                </div>
                <p class="text-gray-200 mt-3 whitespace-pre-wrap">${data.comment}</p>
                <div class="replies-container mt-4 space-y-3 pl-4"></div>
            `;
            
            if(adminControls) {
                card.querySelector('.reply-btn').addEventListener('click', () => showReplyForm(commentId, card));
            }

            const repliesContainer = card.querySelector('.replies-container');
            fetchAndDisplayReplies(commentId, repliesContainer);
            
            return card;
        };

        // --- FIRESTORE LOGIC ---
        const listenForFeedback = (auth) => {
            const feedbackCollection = collection(db, `artifacts/${appId}/public/data/feedback`);
            const q = query(feedbackCollection);

            onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden');
                errorState.classList.add('hidden');

                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                    feedbackList.innerHTML = '';
                    feedbackList.appendChild(emptyState);
                } else {
                    emptyState.classList.add('hidden');
                    const comments = [];
                    snapshot.forEach(doc => comments.push(doc));
                    
                    comments.sort((a, b) => {
                        const timeA = a.data().timestamp?.seconds || 0;
                        const timeB = b.data().timestamp?.seconds || 0;
                        return timeB - timeA;
                    });

                    feedbackList.innerHTML = '';
                    comments.forEach(doc => {
                        const commentEl = renderComment(doc, auth);
                        feedbackList.appendChild(commentEl);
                    });
                }
            }, (error) => {
                console.error("Error listening for feedback:", error);
                showError("Failed to load feedback. Check your Firestore security rules and configuration.");
            });
        };

        const submitReply = async (feedbackId, replyText, commentContainer) => {
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                alert("You are not authorized to reply.");
                return;
            }
            const replyRef = doc(db, `artifacts/${appId}/public/data/feedback/${feedbackId}/replies`, crypto.randomUUID());
            try {
                await setDoc(replyRef, {
                    text: replyText,
                    timestamp: serverTimestamp(),
                    author: "Developer"
                });
                commentContainer.querySelector('.reply-form-container').remove();
            } catch (error) {
                console.error("Error submitting reply:", error);
                alert("Failed to submit reply.");
            }
        };

        const fetchAndDisplayReplies = async (feedbackId, repliesContainer) => {
            const repliesQuery = query(collection(db, `artifacts/${appId}/public/data/feedback/${feedbackId}/replies`));
            
            onSnapshot(repliesQuery, (querySnapshot) => {
                repliesContainer.innerHTML = '';
                const replies = [];
                querySnapshot.forEach((doc) => replies.push(doc.data()));

                replies.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeA - timeB;
                });

                replies.forEach(data => {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'comment-reply p-3 rounded-lg';
                    replyDiv.innerHTML = `<p class="font-bold text-brass">${data.author}</p><p class="text-gray-300 whitespace-pre-wrap">${data.text}</p>`;
                    repliesContainer.appendChild(replyDiv);
                });
            }, (error) => {
                console.error(`Error fetching replies for ${feedbackId}:`, error);
            });
        };

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const category = document.getElementById('category').value;
            const comment = document.getElementById('comment').value;

            try {
                const feedbackCollection = collection(db, `artifacts/${appId}/public/data/feedback`);
                await addDoc(feedbackCollection, {
                    username,
                    category,
                    comment,
                    timestamp: serverTimestamp()
                });
                feedbackForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                showError("Your comment could not be submitted. Please try again.");
            }
        });

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', init);

        // --- Expose functions to the console for admin login ---
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.getAuth = getAuth;
    </script>
</body>
</html>

